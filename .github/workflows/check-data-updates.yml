# .github/workflows/check-data-updates.yml
# 
# This workflow monitors Michigan lead data sources for updates and creates
# GitHub Issues to alert when changes are detected.
#
# Data sources monitored:
# 1. Michigan 90th Percentile API (Socrata)
# 2. EGLE DSMI Inventories page
# 3. EGLE Lead & Copper Rule page
#
# Runs daily at 9 AM Eastern (14:00 UTC)

name: Check for Data Updates

on:
  schedule:
    # Run daily at 9 AM Eastern (14:00 UTC, or 13:00 during DST)
    - cron: '0 14 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Fetch data and check for updates
        id: fetch
        run: python scripts/fetch_data.py
        continue-on-error: true

      - name: Set workflow outputs from state
        id: outputs
        run: |
          if [ -f "data/data-state.json" ]; then
            python3 -c 'import json,os;s=json.load(open("data/data-state.json"));c=s.get("changes_count",0);ch=json.dumps(s.get("changes",[])).replace("%","%25").replace("\n","%0A").replace("\r","%0D");fs=str(s.get("fetch_success",True)).lower();fe=json.dumps(s.get("fetch_errors",[])).replace("%","%25").replace("\n","%0A").replace("\r","%0D");open(os.environ["GITHUB_OUTPUT"],"a").write(f"changes_detected={str(c>0).lower()}\nchanges_count={c}\nchanges_json={ch}\nfetch_success={fs}\nfetch_errors={fe}\n")'
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "changes_count=0" >> $GITHUB_OUTPUT
            echo "changes_json=[]" >> $GITHUB_OUTPUT
            echo "fetch_success=true" >> $GITHUB_OUTPUT
            echo "fetch_errors=[]" >> $GITHUB_OUTPUT
          fi

      - name: Commit data and state
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/ || true
          git diff --staged --quiet || git commit -m "Update data and state [skip ci]"
          git push || true

      - name: Create issue if changes or fetch errors
        if: steps.outputs.outputs.changes_detected == 'true' || steps.outputs.outputs.fetch_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const changesCount = '${{ steps.outputs.outputs.changes_count }}';
            const changesJson = decodeURIComponent('${{ steps.outputs.outputs.changes_json }}'.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%'));
            const fetchErrorsJson = decodeURIComponent('${{ steps.outputs.outputs.fetch_errors }}'.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%'));
            
            let changes;
            try { changes = JSON.parse(changesJson); } catch (e) { changes = []; }
            let fetchErrors;
            try { fetchErrors = JSON.parse(fetchErrorsJson); } catch (e) { fetchErrors = []; }
            
            const date = new Date().toISOString().split('T')[0];
            const hasChanges = changes.length > 0;
            const hasFetchErrors = fetchErrors.length > 0;
            
            let body = hasChanges ? `## üö® Data Source Update Detected\n\n` : `## ‚ö†Ô∏è Data Fetch Alert\n\n`;
            body += `**Date:** ${date}\n`;
            if (hasChanges) body += `**Changes Found:** ${changesCount}\n`;
            if (hasFetchErrors) body += `**Fetch Failures:** ${fetchErrors.length} source(s)\n`;
            body += `\n---\n\n`;
            
            if (hasChanges) {
              body += `### Changed Sources\n\n`;
              for (const change of changes) {
                body += `#### ${change.source}\n`;
                body += `- **Type:** ${change.type}\n`;
                body += `- **Details:** ${change.details}\n`;
                if (change.file) body += `- **File:** ${change.file}\n`;
                body += `\n`;
              }
            }
            
            if (hasFetchErrors) {
              body += `### Fetch Errors\n\n`;
              for (const err of fetchErrors) {
                body += `#### ${err.name}\n`;
                body += `- **Error:** ${err.error}\n\n`;
              }
            }
            
            body += `---\n\n### Recommended Actions\n\n`;
            body += `1. Review the above\n`;
            if (hasFetchErrors) body += `2. Data was restored from backup (fetch failed for some sources)\n`;
            if (hasChanges && !hasFetchErrors) body += `2. Data has been fetched to \`data/\` (backup at \`data-backup/\`)\n`;
            body += `3. Run the conversion script: \`node scripts/convertCsv.js\`\n`;
            body += `4. Test locally: \`npm start\`\n`;
            body += `5. Deploy: \`npm run deploy\`\n\n`;
            body += `*This issue was automatically created by the data monitoring workflow.*`;
            
            let title = `üìä Data Alert: `;
            if (hasChanges && hasFetchErrors) title += `${changesCount} change(s), ${fetchErrors.length} fetch failure(s)`;
            else if (hasChanges) title += `${changesCount} source(s) changed`;
            else title += `${fetchErrors.length} fetch failure(s)`;
            title += ` - ${date}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['data-update', 'automated']
            });
